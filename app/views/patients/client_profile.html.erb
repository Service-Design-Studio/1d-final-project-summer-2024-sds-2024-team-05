<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Client Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>" async defer></script>
  <style>
    video {
      width: 100%;
    }

    p {
      font-size: 1.5em;
    }

    .text-orange {
      color: #fd7e14;
    }

    .text-danger {
      color: red;
    }

    .disabled {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div class="container my-5">
    <a href="<%= patients_dashboard_path %>" style="text-decoration: none; color: black;" class="d-flex align-items-center">
      <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
      </svg>
      <span style="font-size: 1.3em" class="mx-2">Back to Dashboard</span>
    </a>
    <h1 style="margin-top: 1em;"><%= @form.first_name %> <%= @form.last_name %></h1>
    <ul class="nav nav-tabs" id="clientTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="client-tab" data-bs-toggle="tab" data-bs-target="#client" type="button" role="tab" aria-controls="client" aria-selected="true">Client Info</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= assessment_tab_class(@form) %>" id="assessment-tab" data-bs-toggle="tab" data-bs-target="#assessment" type="button" role="tab" aria-controls="assessment" aria-selected="false">Patient Assessment</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= meeting_tab_class(@form, @meeting) %> <%= meeting_tab_disabled?(@form) %>" id="meeting-tab" data-bs-toggle="tab" data-bs-target="#meeting" type="button" role="tab" aria-controls="meeting" aria-selected="false">Meeting Details</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="nok-tab" data-bs-toggle="tab" data-bs-target="#nok" type="button" role="tab" aria-controls="nok" aria-selected="false">NOK Details</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="discharge-tab" data-bs-toggle="tab" data-bs-target="#discharge" type="button" role="tab" aria-controls="discharge" aria-selected="false">Discharge Summary</button>
      </li>
    </ul>
    <div class="tab-content" id="clientTabsContent">
      <div class="tab-pane fade show active" id="client" role="tabpanel" aria-labelledby="client-tab">
        <div id="clientDetails">
          <p style="font-size:2em">
            <strong>Action Required: </strong>
            <span 
              id="actionRequiredText" 
              style="color: <%= @form.status_colour %>; cursor: pointer;" 
              onclick="handleActionRequiredClick('<%= @form.application_status %>')"
            >
              <%= @form.application_status %>
            </span>
          </p>
          <p><strong>Form No.:</strong> <%= @form.id %></p>
          <p><strong>Gender:</strong> <%= @form.gender %></p>
          <p><strong>Birthday:</strong> <%= @form.date_of_birth %></p>
          <p style="font-size:2em"><strong>Type of Care:</strong> <%= @form.services %></p>
          <p><strong>Start Date Required:</strong> <%= @form.start_date %></p>
          <p><strong>Physical Assessment:</strong> <%= @form.physical_assessment.presence || "Pending Assessment" %></p>
          <p><strong>Mental Assessment:</strong> <%= @form.mental_assessment.presence || "Pending Assessment" %></p>
          <hr/>
          <p style="font-size:2em"><strong>Address:</strong> <%= @form.address %></p>
          <div id="map" style="height: 400px; width: 100%;"></div>
        </div>
      </div>
      <div class="tab-pane fade" id="assessment" role="tabpanel" aria-labelledby="assessment-tab">
        <%= form_with model: @form, local: true do |form| %>
          <p style="font-size:2em"><strong>Patient Assessment:</strong></p>
          <div class="row align-items-start">
            <div class="col-md-6">
              <p><strong>Physical Video:</strong></p>
              <% if @form.physical_video.present? %>
                <%= video_tag url_for(@form.physical_video), controls: true, class: "img-thumbnail" %>
              <% else %>
                <p>null</p>
              <% end %>
            </div>
            <div class="col-md-6">
              <p><strong>Physical Assessment: </strong><%= @form.physical_assessment.presence || "Pending Assessment" %></p>
              <fieldset>
                <div class="form-check form-check-inline">
                  <%= form.radio_button :physical_assessment, "Good", class: "form-check-input", id: "good", checked: @form.physical_assessment == "Good", :required => false %>
                  <%= form.label "good", class: "form-check-label", for: "good" do %>
                    Good
                  <% end %>
                </div>

                <div class="form-check form-check-inline">
                  <%= form.radio_button :physical_assessment, "Fair", class: "form-check-input", id: "fair", checked: @form.physical_assessment == "Fair", :required => false %>
                  <%= form.label "fair", class: "form-check-label", for: "fair" do %>
                    Fair
                  <% end %>
                </div>

                <div class="form-check form-check-inline">
                  <%= form.radio_button :physical_assessment, "Poor", class: "form-check-input", id: "poor", checked: @form.physical_assessment == "Poor", :required => false %>
                  <%= form.label "poor", class: "form-check-label", for: "poor" do %>
                    Poor
                  <% end %>
                </div>

                <div class="form-check form-check-inline">
                  <%= form.radio_button :physical_assessment, "Detailed Assessment Needed", class: "form-check-input", id: "others", checked: !["Good", "Fair", "Poor", ""].include?(@form.physical_assessment) %>
                  <%= form.label "others", class: "form-check-label", for: "others" do %>
                    Detailed Assessment Needed:
                  <% end %>
                </div>
                <br><br>
                <div class="form-check">
                  <%= form.text_field :others_text, class: "form-control", id: "others_text", placeholder: "Detailed Assessment here", style: "font-style: italic;", value: (!["Good", "Fair", "Poor", ""].include?(@form.physical_assessment)) ? @form.physical_assessment : '' %>
                </div>
              </fieldset>
            </div>
          </div>

          <hr/>

          <div class="row align-items-start">
            <div class="col-md-6">
              <p><strong>Mental Video:</strong></p>
              <% if @form.mental_video.present? %>
                <%= video_tag url_for(@form.mental_video), controls: true, class: "img-thumbnail" %>
              <% else %>
                <p>null</p>
              <% end %>
            </div>
            <div class="col-md-6">
              <p><strong>Mental Assessment: </strong><%= @form.mental_assessment.presence || "Pending Assessment" %></p>
              <fieldset>
                <div class="form-check form-check-inline">
                  <%= form.radio_button :mental_assessment, "Good", class: "form-check-input", id: "good_mental", checked: @form.mental_assessment == "Good", :required => false %>
                  <%= form.label "good_mental", class: "form-check-label", for: "good_mental" do %>
                    Good
                  <% end %>
                </div>

                <div class="form-check form-check-inline">
                  <%= form.radio_button :mental_assessment, "Fair", class: "form-check-input", id: "fair_mental", checked: @form.mental_assessment == "Fair", :required => false %>
                  <%= form.label "fair_mental", class: "form-check-label", for: "fair_mental" do %>
                    Fair
                  <% end %>
                </div>

                <div class="form-check form-check-inline">
                  <%= form.radio_button :mental_assessment, "Poor", class: "form-check-input", id: "poor_mental", checked: @form.mental_assessment == "Poor", :required => false %>
                  <%= form.label "poor_mental", class: "form-check-label", for: "poor_mental" do %>
                    Poor
                  <% end %>
                </div>

                <div class="form-check form-check-inline">
                  <%= form.radio_button :mental_assessment, "Detailed Assessment Needed", class: "form-check-input", id: "others_mental", checked: !["Good", "Fair", "Poor", ""].include?(@form.mental_assessment) %>
                  <%= form.label "others_mental", class: "form-check-label", for: "others_mental" do %>
                    Detailed Assessment Needed:
                  <% end %>
                </div>
                <br><br>
                <div class="form-check">
                  <%= form.text_field :others_mental_text, class: "form-control", id: "others_mental_text", placeholder: "Detailed Assessment here", style: "font-style: italic;", value: (!["Good", "Fair", "Poor", ""].include?(@form.mental_assessment)) ? @form.mental_assessment : '' %>
                </div>
              </fieldset>
            </div>
          </div>

          <hr/>

          <div class="row align-items-start">
            <div class="col-md-6">
              <p><strong>Environmental Video:</strong></p>
              <% if @form.environment_video.present? %>
                <%= video_tag url_for(@form.environment_video), controls: true, class: "img-thumbnail" %>
              <% else %>
                <p>null</p>
              <% end %>
            </div>
            <div class="col-md-6">
              <p><strong>Environmental Assessment: </strong><%= @form.environment_assessment.presence || "Pending Assessment" %></p>
              <fieldset>
                <div class="form-check form-check-inline">
                  <%= form.radio_button :environment_assessment, "Good", class: "form-check-input", id: "good_environment", checked: @form.environment_assessment == "Good", :required => false %>
                  <%= form.label "good_environment", class: "form-check-label", for: "good_environment" do %>
                    Good
                  <% end %>
                </div>

                <div class="form-check form-check-inline">
                  <%= form.radio_button :environment_assessment, "Fair", class: "form-check-input", id: "fair_environment", checked: @form.environment_assessment == "Fair", :required => false %>
                  <%= form.label "fair_environment", class: "form-check-label", for: "fair_environment" do %>
                    Fair
                  <% end %>
                </div>

                <div class="form-check form-check-inline">
                  <%= form.radio_button :environment_assessment, "Poor", class: "form-check-input", id: "poor_environment", checked: @form.environment_assessment == "Poor", :required => false %>
                  <%= form.label "poor_environment", class: "form-check-label", for: "poor_environment" do %>
                    Poor
                  <% end %>
                </div>

                <div class="form-check form-check-inline">
                  <%= form.radio_button :environment_assessment, "Detailed Assessment Needed", class: "form-check-input", id: "others_environment", checked: !["Good", "Fair", "Poor", ""].include?(@form.environment_assessment) %>
                  <%= form.label "others_environment", class: "form-check-label", for: "others_environment" do %>
                    Detailed Assessment Needed:
                  <% end %>
                </div>
                <br><br>
                <div class="form-check">
                  <%= form.text_field :others_environment_text, class: "form-control", id: "others_environment_text", placeholder: "Detailed Assessment here", style: "font-style: italic;", value: (!["Good", "Fair", "Poor", ""].include?(@form.environment_assessment)) ? @form.environment_assessment : '' %>
                </div>
              </fieldset>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-12">
              <%= form.submit "Save", class: "btn btn-primary mt-3" %>
            </div>
          </div>
        <% end %>
      </div>

      <div class="tab-pane fade" id="meeting" role="tabpanel" aria-labelledby="meeting-tab">
        <div id="setMeeting">
          <h1>Meetings</h1>
          <%= month_calendar(events: @meetings) do |date, meetings| %>
            <div class="day">
              <%= date.day %>
            </div>
            <% meetings.each do |meeting| %>
              <div>
                <%= meeting.title %>
              </div>
            <% end %>
          <% end %>
                    <p style="font-size:2em"><strong>Meeting Details:</strong></p>

          <%= form_with(model: @meeting) do |form| %>
            <% if @meeting.errors.any? %>
              <div style="color: red">
                <h2><%= pluralize(@meeting.errors.count, "error") %> prohibited this meeting from being saved:</h2>
                <ul>
                  <% @meeting.errors.each do |error| %>
                    <li><%= error.full_message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            <div id="form_id">
              <input type="hidden" id="meeting_form_id" name="meeting[form_id]" value="<%= @form.id %>">
            </div>
            <div>
              <%= form.label :description, style: "display: block" %>
              <%= form.text_area :description %>
            </div>
            <div>
              <%= form.label :location, style: "display: block" %>
              <%= form.text_area :location %>
            </div>
            <div>
              <%= form.label :start_time, style: "display: block" %>
              <%= form.datetime_field :start_time %>
            </div>
            <div>
              <%= form.label :end_time, style: "display: block" %>
              <%= form.datetime_field :end_time %>
            </div>
            <div>
              <%= form.submit %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="tab-pane fade" id="discharge" role="tabpanel" aria-labelledby="discharge-tab">
        <div id="dischargeDetails">
          <p style="font-size:2em"><strong>Discharge Summary:</strong></p>
          <% if @form.discharge_summary.present? %>
            <%= image_tag @form.discharge_summary, class: "img-thumbnail", style: "max-width: 300px;" %>
          <% else %>
            <p>Discharge Summary Not Available</p>
          <% end %>        
        </div>
      </div>

      <div class="tab-pane fade" id="nok" role="tabpanel" aria-labelledby="nok-tab">
        <div id="nokDetails">
          <p style="font-size:2em"><strong>NOK Name:</strong> <%= @form.nok_first_name %> <%= @form.nok_last_name %></p>
          <p><strong>Relationship:</strong> <%= @form.relationship %></p>
          <p><strong>Address: </strong> <%= @form.nok_address %></p>
          <p><strong>Contact:</strong> <%= @form.nok_contact_no %></p>
          <p><strong>Email:</strong> <%= @form.nok_email %></p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      initMap('<%= @form.address %>');
    });

    function initMap(address) {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ 'address': address }, function(results, status) {
        if (status === 'OK') {
          const map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: results[0].geometry.location
          });
          const marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
          });
        } else {
          console.error('Geocode was not successful for the following reason: ' + status);
        }
      });
    }

    function handleActionRequiredClick(status) {
      if (status === 'Pending Assessment') {
        var assessmentTab = new bootstrap.Tab(document.getElementById('assessment-tab'));
        assessmentTab.show();
      } else if (status === 'Meeting Date Pending') {
        var meetingTab = new bootstrap.Tab(document.getElementById('meeting-tab'));
        meetingTab.show();
      }
    }
  </script>
</body>
</html>
