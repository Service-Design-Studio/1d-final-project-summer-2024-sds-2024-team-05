<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Client Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>" async defer></script>
  <style>
    video {
      width: 100%;
    }

    p {
      font-size: 1.5em;
    }

    .text-orange {
      color: #fd7e14;
    }

    .text-danger {
      color: red;
    }

    .disabled {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div class="container my-5">
    <span onclick="window.location.href='<%= admin_root_path %>'" style="cursor: pointer; color: inherit; text-decoration: none;">
      <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
      </svg>
      <span style="font-size: 1.3em" class="mx-2">Back to Dashboard</span>
    </span>
    <h1 style="margin-top: 1em;"><%= @form.first_name %> <%= @form.last_name %></h1>
    <ul class="nav nav-tabs" id="clientTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="client-tab" data-bs-toggle="tab" data-bs-target="#client" type="button" role="tab" aria-controls="client" aria-selected="true">Client Info</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link <%= assessment_tab_class(@form) %>" id="assessment-tab" data-bs-toggle="tab" data-bs-target="#assessment" type="button" role="tab" aria-controls="assessment" aria-selected="false">Patient Assessment</button>
      </li>

      <li class="nav-item" role="presentation">
        <button class="nav-link <%= meeting_tab_class(@form) %> <%= meeting_tab_disabled?(@form) %>" id="meeting-tab" data-bs-toggle="tab" data-bs-target="#meeting" type="button" role="tab" aria-controls="meeting" aria-selected="false">Meeting Details</button>
      </li>

      <li class="nav-item" role="presentation">
        <button class="nav-link" id="nok-tab" data-bs-toggle="tab" data-bs-target="#nok" type="button" role="tab" aria-controls="nok" aria-selected="false">NOK Details</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="discharge-tab" data-bs-toggle="tab" data-bs-target="#discharge" type="button" role="tab" aria-controls="discharge" aria-selected="false">Discharge Summary</button>
      </li>
    </ul>

    <div class="tab-content" id="clientTabsContent">
      <div class="tab-pane fade show active" id="client" role="tabpanel" aria-labelledby="client-tab">
        <div id="clientDetails">
          <p style="font-size:2em">
            <strong>Action Required: </strong>
            <span 
              id="actionRequiredText" 
              style="color: <%= status_colour(@form) %>; cursor: pointer;" > <!-- status_colour is called in helper-->
              onclick="handleActionRequiredClick('<%= application_status(@form) %>')"
            >
              <%= application_status(@form) %> <!-- application_status is called in helper-->
            </span>
          </p>
          <p><strong>Form No.:</strong> <%= @form.id %></p>
          <p><strong>Gender:</strong> <%= @form.gender %></p>
          <p><strong>Birthday:</strong> <%= @form.date_of_birth %></p>
          <p style="font-size:2em"><strong>Type of Care:</strong> <%= @form.services %></p>
          <p><strong>Start Date Required:</strong> <%= @form.start_date %></p>
          <p><strong>Physical Assessment:</strong> <%= @form.physical_assessment.presence || "Pending Assessment" %></p>
          <p><strong>Mental Assessment:</strong> <%= @form.mental_assessment.presence || "Pending Assessment" %></p>
          <hr/>
          <p style="font-size:2em"><strong>Address:</strong> <%= @form.address %></p>
          <div id="map" style="height: 400px; width: 100%;"></div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="meeting" role="tabpanel" aria-labelledby="meeting-tab">
        <div id="meetingDetails">
          <%= render partial: 'meetings/calendar', meeting: @meetings %>
          <%= render partial: 'meetings/new', form: @form, meeting: @meeting %>
        </div>
      </div>

      <div class="tab-pane fade" id="discharge" role="tabpanel" aria-labelledby="discharge-tab">
        <div id="dischargeDetails">
          <p>???</p>      
        </div>
      </div>

      <div class="tab-pane fade" id="nok" role="tabpanel" aria-labelledby="nok-tab">
        <div id="nokDetails">
          <p style="font-size:2em"><strong>NOK Name:</strong> <%= @form.nok_first_name %> <%= @form.nok_last_name %></p>
          <p><strong>Relationship:</strong> <%= @form.relationship %></p>
          <p><strong>Address: </strong> <%= @form.nok_address %></p>
          <p><strong>Contact:</strong> <%= @form.nok_contact_no %></p>
          <p><strong>Email:</strong> <%= @form.nok_email %></p>
        </div>
      </div>

      <div class="tab-pane fade" id="assessment" role="tabpanel" aria-labelledby="assessment-tab">
        <div id="assessmentDetails">
          <%= render 'physical_assessment', form: @form %>
          <hr/>
          <%= render 'mental_assessment', form: @form %>
          <hr/>
          <%= render 'environment_assessment', form: @form %>
          <hr/>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var urlParams = new URLSearchParams(window.location.search);
      var status = urlParams.get('status');

      if (status === 'Pending Assessment') {
        var assessmentTab = new bootstrap.Tab(document.getElementById('assessment-tab'));
        assessmentTab.show();
      } else if (status === 'Meeting Date Pending') {
        var meetingTab = new bootstrap.Tab(document.getElementById('meeting-tab'));
        meetingTab.show();
      }
      initMap('<%= @form.address %>');
    });

    function initMap(address) {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ 'address': address }, function(results, status) {
        if (status === 'OK') {
          const map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: results[0].geometry.location
          });
          const marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
          });
        } else {
          console.error('Geocode was not successful for the following reason: ' + status);
        }
      });
    }

    function handleActionRequiredClick(status) {
      if (status === 'Pending Assessment') {
        var assessmentTab = new bootstrap.Tab(document.getElementById('assessment-tab'));
        assessmentTab.show();
      } else if (status === 'Meeting Date Pending') {
        var meetingTab = new bootstrap.Tab(document.getElementById('meeting-tab'));
        meetingTab.show();
      }
    }
  </script>
</body>
</html>
